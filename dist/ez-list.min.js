!function(){"use strict";angular.module("ez.list",[]).constant("EzListConfig",{mode:"insert",acceptClass:"ez-dragging",idField:"id",listChildrenField:"items",childrenField:"items",collapsedField:"collapsed",showPlaceholder:!0,collapsed:!0,allowDrag:!0,allowNesting:!0,openOnSlide:!0,closeOnDrag:!1,dropOnly:!1,xThreshold:15,yThreshold:5,api:{onMove:null,onDrop:null},transcludeMethods:{}}).directive("ezList",["EzListConfig","Draggable",function(a,b){return{restrict:"A",replace:!0,transclude:!0,scope:{item:"=?ezList",config:"=?",selectedItems:"=?"},template:"<div class=\"ez-list\" ng-class=\"{'ez-list-draggable': options.allowDrag, 'ez-list-dropable': options.mode == 'drop', 'ez-no-placeholder': !options.showPlaceholder, 'ez-droponly': options.dropOnly, 'ez-list-empty': !hasItems}\"><ul class=\"ez-list-items\">"+'<li class="ez-list-item" ng-repeat="item in item[options.childrenField]" ng-include="\'ez-list-tpl.html\'"></li></ul></div>',link:function(c,d,e,f,g){c.options=angular.extend({},a,c.config),c.options.transclude=g,c.depth=0;for(var h in c.options.transcludeMethods)c[h]=c.options.transcludeMethods[h];var i=d[0];"drop"===c.options.mode&&(c.options.allowNesting=!1,c.options.openOnSlide=!1,c.options.showPlaceholder=!1),c.$watch("selectedItems",function(a,b){a!==b&&c.$broadcast("ez_list.selected_changed")}),c.item?c.$watchCollection("item."+c.options.childrenField,function(a){c.hasItems=a&&a.length,a&&a.length>0&&d.hasClass("has-dropzone")&&(d.removeClass("has-dropzone"),b.unsetDropzone(i)),a||d.hasClass("has-dropzone")||(d.addClass("has-dropzone"),b.setDropzone(i,c.options))}):(c.item={},c.hasItems=!1,d.addClass("has-dropzone"),b.setDropzone(i,c.options))}}}]).directive("ezListItemContent",["Draggable",function(a){return{restrict:"C",link:function(b,c){var d=c[0];(b.options.allowDrag===!0||"function"==typeof b.options.allowDrag&&b.options.allowDrag(b.item))&&a.initDragItem(d,b),b.item._parentItem=b.$parent.$parent.item,b.options.transclude&&b.options.transclude(b,function(a){c.append(a)});var e=function(a){a.hasOwnProperty("_parentItem")&&e(a._parentItem),a._active=!0},f=function(){b.selectedItems&&(Array.isArray(b.selectedItems)?$.grep(b.selectedItems,function(a){return"string"==typeof a?b.item[b.options.idField]===a?!0:!1:a&&a[b.options.idField]===b.item[b.options.idField]?!0:!1}).length&&(b.item._selected=!0,e(b.item,!0)):"string"==typeof b.selectedItems&&b.selectedItems===b.item[b.options.idField]?(b.item._selected=!0,e(b.item,!0)):b.selectedItems[b.options.idField]===b.item[b.options.idField]&&(b.item._selected=!0,e(b.item,!0)))};b.item.hasOwnProperty("collapsed")||(b.item[b.options.collapsedField]=b.options.collapsed),b.$watchCollection("item."+b.options.childrenField,function(a){b.hasItems=a&&a.length}),b.remove=function(){b.$parent.$parent.item[b.options.childrenField].splice(b.$parent.$parent.item[b.options.childrenField].indexOf(b.item),1)},b.$on("ez_list.selected_changed",function(){delete b.item._active,delete b.item._selected,f()}),f()}}}]).factory("Draggable",[function(){var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u=angular.element('<ul class="ez-drag-container"></ul>')[0],v=angular.element('<li class="ez-placeholder"></li>')[0],w=0,x=0,y=0,z=0,A=0,B={};return{setDropzones:function(){c.find(".ez-list-item-content").removeClass("ez-dropzone"),m=interact(".ez-dropzone").dropzone({ondragenter:this.enter.bind(this),ondragleave:this.leave.bind(this)})},setDropzone:function(a,b){interact(a).dropzone({accept:b.accept,ondragenter:this.enter.bind(this),ondragleave:this.leave.bind(this)})},unsetDropzone:function(a){interact(a).dropzone(!1)},unsetDropzones:function(){m.unset(),c.find(".ez-list-item-content").addClass("ez-dropzone")},initDragItem:function(a,b){var c=this;interact(a).draggable({onstart:function(a){c.start(a,b)},onmove:function(a){c.move(a)},onend:function(a){c.end(a)}}).actionChecker(function(a,b){return a&&"undefined"!=typeof a.button?0===a.button?b:null:b})},enter:function(a){var b;angular.element(a.target).hasClass("ez-list")?(b=a.target,this.setDropItem(a.target)):(this.setDropItem(a.target.parentNode.parentNode),j.children[0].children[0].classList.add("ez-dragover"),b=k.closest(".ez-list")[0]),b!==o&&(o&&(r=o,s=p,t=q,r.classList.remove("ez-list-target")),o=b,p=angular.element(o),q=p.isolateScope(),o.classList.add("ez-list-target"),b=null)},leave:function(){k.hasClass("ez-list-item")&&j.children[0].children[0].classList.remove("ez-dragover"),k.hasClass("ez-list")?o.classList.remove("ez-list-target"):"insert"===q.options.mode&&("up"===i?this.moveUp():this.moveDown()),l=j=k=null,q.options.dropOnly&&(o.classList.remove("ez-list-target"),o=p=q=null)},start:function(h,i){!h.target.hasAttribute("ez-drag-handle")||"undefined"!=typeof h.button&&0!==h.button||(h.preventDefault(),h.stopPropagation(),c=angular.element(h.target).closest(".ez-list-item"),b=c[0],e=c[0].parentNode,p=$(h.target).closest(".ez-list"),o=p[0],q=p.isolateScope(),this.setDropzones(),B=q.options,a=i.item,f=i.$parent.$parent,d=f.item,g=d[q.options.childrenField].indexOf(a),this.initDragContainer(),B.closeOnDrag?(a[B.collapsedField]=!0,f.$apply()):v.style.height=c.height()+"px",c.addClass(q.options.acceptClass),e.insertBefore(v,b),u.parentNode!==o&&o.appendChild(u),u.appendChild(b),p.addClass("ez-drag-origin"),p.addClass("ez-list-target"),interact.dynamicDrop(!0),c.addClass("ez-dragging"))},move:function(a){return y+=a.dx,z+=a.dy,this.setDragContainerElPosition(),null!==o&&"insert"===q.options.mode?q.options.allowNesting&&0!==a.dx&&0===a.dy&&(h=a.dx>0?"right":"left",n!==h&&(A=0,n=h),A+=Math.abs(a.dx),A>q.options.xThreshold)?(A=0,void("right"===h?this.moveRight():this.moveLeft())):void(!j||Math.abs(a.dx)>5||0===a.dy||(i=a.dy>0?"down":"up")):void 0},end:function(){var b=this;interact.dynamicDrop(!1),j&&k.hasClass("ez-list-item")&&j.children[0].children[0].classList.remove("ez-dragover"),d[B.childrenField].splice(g,1),f.$apply(),this.removeDragElement(),o?"insert"===q.options.mode&&v.parentNode?(this.setDropItem(v.parentNode),"function"==typeof f.options.api.onMove?q.options.api.onMove(a,l).then(function(){b.moveItem()},function(){b.returnItem()}):b.moveItem(!0)):"drop"===q.options.mode?"function"==typeof q.options.api.onDrop&&q.options.api.onDrop(a,l).then(function(){b.destroy()},function(){b.returnItem()}):this.returnItem(!0):this.returnItem(!0)},moveItem:function(b){var c=this;if(l.hasOwnProperty(q.options.childrenField)){var d=Array.prototype.indexOf.call(v.parentNode.children,v);l[q.options.childrenField].splice(d,0,a)}else l[q.options.childrenField]=[a];b&&f.$apply(),c.destroy()},removeDragElement:function(){u.removeChild(b)},removePlaceholder:function(){v.parentNode&&v.parentNode.removeChild(v)},returnItem:function(b){d[B.childrenField].splice(g,0,a),b&&f.$apply(),this.destroy()},initDragContainer:function(){var a=o.getBoundingClientRect(),c=b.getBoundingClientRect();y=0,z=0,w=c.left-a.left,x=c.top-a.top,u.style.top=x+2+"px",u.style.left=w+2+"px",u.style.width=c.right-c.left-1+"px",this.setDragContainerElPosition()},setDropItem:function(a){j=a,k=angular.element(a),l=k.scope().item},setDragContainerElPosition:function(){u.style.webkitTransform=u.style.transform="translate3D("+y+"px, "+z+"px, 0px)"},moveLeft:function(){v.nextElementSibling||(this.setDropItem(v.parentNode.parentNode.parentNode),l&&j&&j.nextSibling&&j.parentNode.insertBefore(v,j.nextSibling))},moveRight:function(){v.previousElementSibling&&(this.setDropItem(v.previousElementSibling),q.options.openOnSlide&&l[q.options.collapsedField]===!0?(l[q.options.collapsedField]=!1,q.$apply(),j.children[0].children[1].insertBefore(v,j.children[0].children[1].children[0])):j.children[0].children[1].appendChild(v))},moveUp:function(){j.parentNode.insertBefore(v,j)},moveDown:function(){var a=j.children[0].children[1];a&&a.children[0]?a.insertBefore(v,a.children[0]):j.parentNode.insertBefore(v,j.nextElementSibling)},destroy:function(){this.removePlaceholder(),c.removeClass(B.acceptClass),o&&(o.classList.remove("ez-drag-origin"),o.classList.remove("ez-list-target")),r&&(r.classList.remove("ez-drag-origin"),r.classList.remove("ez-list-target")),this.unsetDropzones(),r=s=t=o=p=q=c=b=d=e=a=g=null}}}])}();